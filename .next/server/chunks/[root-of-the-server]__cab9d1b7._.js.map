{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/db.ts"],"sourcesContent":["// lib/db.ts - Prisma client singleton\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ||\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\"] : [],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\r\n\r\nexport default prisma;\r\n"],"names":[],"mappings":"AAAA,sCAAsC;;;;;;;AACtC;;AAEA,MAAM;AAEC,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;KAAQ,GAAG;AAC5D;AAEF,wCAA2C,gBAAgB,MAAM,GAAG;uCAErD","debugId":null}},
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/razorpay-utils.ts"],"sourcesContent":["// lib/razorpay-utils.ts - Razorpay payment utilities\r\nimport crypto from \"crypto\";\r\n\r\nconst RAZORPAY_KEY_ID = process.env.RAZORPAY_KEY_ID || \"\";\r\nconst RAZORPAY_KEY_SECRET = process.env.RAZORPAY_KEY_SECRET || \"\";\r\n\r\n/**\r\n * Generate unique receipt ID\r\n */\r\nexport function generateReceiptId(): string {\r\n  return `aerocity-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;\r\n}\r\n\r\n/**\r\n * Create Razorpay order\r\n */\r\nexport async function createRazorpayOrder(\r\n  amount: number,\r\n  receipt?: string,\r\n): Promise<{\r\n  id: string;\r\n  entity: string;\r\n  amount: number;\r\n  amount_paid: number;\r\n  amount_due: number;\r\n  currency: string;\r\n  receipt: string;\r\n  offer_id: string | null;\r\n  status: string;\r\n  attempts: number;\r\n  notes: Record<string, any>;\r\n  created_at: number;\r\n}> {\r\n  try {\r\n    const RazorpayAPI = await import(\"razorpay\");\r\n    const razorpay = new RazorpayAPI.default({\r\n      key_id: RAZORPAY_KEY_ID,\r\n      key_secret: RAZORPAY_KEY_SECRET,\r\n    });\r\n\r\n    // Amount in paise (multiply by 100)\r\n    const response = await razorpay.orders.create({\r\n      amount: Math.round(amount * 100),\r\n      currency: \"INR\",\r\n      receipt: receipt || generateReceiptId(),\r\n      payment_capture: true,\r\n    });\r\n\r\n    return response;\r\n  } catch (error) {\r\n    console.error(\"Failed to create Razorpay order:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Verify Razorpay payment signature\r\n */\r\nexport async function verifyRazorpaySignature(\r\n  orderId: string,\r\n  paymentId: string,\r\n  signature: string,\r\n): Promise<boolean> {\r\n  try {\r\n    const data = `${orderId}|${paymentId}`;\r\n    const generated_signature = crypto\r\n      .createHmac(\"sha256\", RAZORPAY_KEY_SECRET)\r\n      .update(data)\r\n      .digest(\"hex\");\r\n\r\n    return generated_signature === signature;\r\n  } catch (error) {\r\n    console.error(\"Failed to verify Razorpay signature:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Get payment details from Razorpay\r\n */\r\nexport async function getPaymentDetails(paymentId: string): Promise<any> {\r\n  try {\r\n    const RazorpayAPI = await import(\"razorpay\");\r\n    const razorpay = new RazorpayAPI.default({\r\n      key_id: RAZORPAY_KEY_ID,\r\n      key_secret: RAZORPAY_KEY_SECRET,\r\n    });\r\n\r\n    const payment = await razorpay.payments.fetch(paymentId);\r\n    return payment;\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch payment details:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Refund payment\r\n */\r\nexport async function refundPayment(\r\n  paymentId: string,\r\n  amount?: number,\r\n): Promise<any> {\r\n  try {\r\n    const RazorpayAPI = await import(\"razorpay\");\r\n    const razorpay = new RazorpayAPI.default({\r\n      key_id: RAZORPAY_KEY_ID,\r\n      key_secret: RAZORPAY_KEY_SECRET,\r\n    });\r\n\r\n    const refundData: any = {\r\n      payment_id: paymentId,\r\n    };\r\n\r\n    if (amount) {\r\n      refundData.amount = Math.round(amount * 100); // Convert to paise\r\n    }\r\n\r\n    const refund = await razorpay.payments.refund(paymentId, refundData);\r\n    return refund;\r\n  } catch (error) {\r\n    console.error(\"Failed to refund payment:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Validate Razorpay credentials\r\n */\r\nexport function validateRazorpayCredentials(): boolean {\r\n  return !!(RAZORPAY_KEY_ID && RAZORPAY_KEY_SECRET);\r\n}\r\n"],"names":[],"mappings":"AAAA,qDAAqD;;;;;;;;;;;;;;;AACrD;;AAEA,MAAM,kBAAkB,QAAQ,GAAG,CAAC,eAAe,IAAI;AACvD,MAAM,sBAAsB,QAAQ,GAAG,CAAC,mBAAmB,IAAI;AAKxD,SAAS;IACd,OAAO,CAAC,SAAS,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG,IAAI;AAC/E;AAKO,eAAe,oBACpB,MAAc,EACd,OAAgB;IAehB,IAAI;QACF,MAAM,cAAc;QACpB,MAAM,WAAW,IAAI,YAAY,OAAO,CAAC;YACvC,QAAQ;YACR,YAAY;QACd;QAEA,oCAAoC;QACpC,MAAM,WAAW,MAAM,SAAS,MAAM,CAAC,MAAM,CAAC;YAC5C,QAAQ,KAAK,KAAK,CAAC,SAAS;YAC5B,UAAU;YACV,SAAS,WAAW;YACpB,iBAAiB;QACnB;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oCAAoC;QAClD,MAAM;IACR;AACF;AAKO,eAAe,wBACpB,OAAe,EACf,SAAiB,EACjB,SAAiB;IAEjB,IAAI;QACF,MAAM,OAAO,GAAG,QAAQ,CAAC,EAAE,WAAW;QACtC,MAAM,sBAAsB,gHAAM,CAC/B,UAAU,CAAC,UAAU,qBACrB,MAAM,CAAC,MACP,MAAM,CAAC;QAEV,OAAO,wBAAwB;IACjC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO;IACT;AACF;AAKO,eAAe,kBAAkB,SAAiB;IACvD,IAAI;QACF,MAAM,cAAc;QACpB,MAAM,WAAW,IAAI,YAAY,OAAO,CAAC;YACvC,QAAQ;YACR,YAAY;QACd;QAEA,MAAM,UAAU,MAAM,SAAS,QAAQ,CAAC,KAAK,CAAC;QAC9C,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oCAAoC;QAClD,MAAM;IACR;AACF;AAKO,eAAe,cACpB,SAAiB,EACjB,MAAe;IAEf,IAAI;QACF,MAAM,cAAc;QACpB,MAAM,WAAW,IAAI,YAAY,OAAO,CAAC;YACvC,QAAQ;YACR,YAAY;QACd;QAEA,MAAM,aAAkB;YACtB,YAAY;QACd;QAEA,IAAI,QAAQ;YACV,WAAW,MAAM,GAAG,KAAK,KAAK,CAAC,SAAS,MAAM,mBAAmB;QACnE;QAEA,MAAM,SAAS,MAAM,SAAS,QAAQ,CAAC,MAAM,CAAC,WAAW;QACzD,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,MAAM;IACR;AACF;AAKO,SAAS;IACd,OAAO,CAAC,CAAC,CAAC,mBAAmB,mBAAmB;AAClD","debugId":null}},
    {"offset": {"line": 181, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/validators.ts"],"sourcesContent":["// lib/validators.ts - Input validation utilities\r\nimport { ValidationError } from \"./errors\";\r\n\r\nexport interface ValidationResult {\r\n  valid: boolean;\r\n  message?: string;\r\n  field?: string;\r\n}\r\n\r\n/**\r\n * Validate email format\r\n */\r\nexport function validateEmail(email: string): boolean {\r\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n  return emailRegex.test(email);\r\n}\r\n\r\n/**\r\n * Validate mobile number (Indian format)\r\n */\r\nexport function validateMobile(mobile: string): boolean {\r\n  // Remove spaces and hyphens\r\n  const cleaned = mobile.replace(/[\\s-]/g, \"\");\r\n  // Accept 10-15 digits\r\n  return /^\\d{10,15}$/.test(cleaned);\r\n}\r\n\r\n/**\r\n * Validate password strength\r\n * Minimum 6 characters\r\n */\r\nexport function validatePassword(password: string): boolean {\r\n  return !!(password && password.length >= 6);\r\n}\r\n\r\n/**\r\n * Validate booking request data\r\n */\r\nexport function validateBookingRequest(data: any): ValidationResult {\r\n  if (!data.visitDate) {\r\n    return { valid: false, message: \"visitDate is required\", field: \"visitDate\" };\r\n  }\r\n\r\n  if (!Array.isArray(data.items) || data.items.length === 0) {\r\n    return {\r\n      valid: false,\r\n      message: \"At least one ticket item is required\",\r\n      field: \"items\",\r\n    };\r\n  }\r\n\r\n  if (!data.customerName || data.customerName.trim().length === 0) {\r\n    return { valid: false, message: \"customerName is required\", field: \"customerName\" };\r\n  }\r\n\r\n  if (!data.customerMobile || !validateMobile(data.customerMobile)) {\r\n    return {\r\n      valid: false,\r\n      message: \"Valid customerMobile is required\",\r\n      field: \"customerMobile\",\r\n    };\r\n  }\r\n\r\n  if (data.customerEmail && !validateEmail(data.customerEmail)) {\n    return { valid: false, message: \"customerEmail must be valid if provided\", field: \"customerEmail\" };\n  }\n\r\n  // Validate booking items\r\n  for (let i = 0; i < data.items.length; i++) {\r\n    const item = data.items[i];\r\n    if (!item.ticketId) {\r\n      return { valid: false, message: `items[${i}].ticketId is required` };\r\n    }\r\n    if (!item.quantity || item.quantity < 1) {\r\n      return { valid: false, message: `items[${i}].quantity must be >= 1` };\r\n    }\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Validate ticket creation\r\n */\r\nexport function validateTicketRequest(data: any): ValidationResult {\r\n  if (!data.name || data.name.trim().length === 0) {\r\n    return { valid: false, message: \"name is required\", field: \"name\" };\r\n  }\r\n\r\n  if (!data.slug || data.slug.trim().length === 0) {\r\n    return { valid: false, message: \"slug is required\", field: \"slug\" };\r\n  }\r\n\r\n  if (data.customerPrice === undefined || data.customerPrice < 0) {\r\n    return {\r\n      valid: false,\r\n      message: \"customerPrice must be >= 0\",\r\n      field: \"customerPrice\",\r\n    };\r\n  }\r\n\r\n  if (data.agentPrice === undefined || data.agentPrice < 0) {\r\n    return { valid: false, message: \"agentPrice must be >= 0\", field: \"agentPrice\" };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Validate offer creation\r\n */\r\nexport function validateOfferRequest(data: any): ValidationResult {\r\n  if (!data.name || data.name.trim().length === 0) {\r\n    return { valid: false, message: \"name is required\", field: \"name\" };\r\n  }\r\n\r\n  if (!data.startDate) {\r\n    return { valid: false, message: \"startDate is required\", field: \"startDate\" };\r\n  }\r\n\r\n  if (!data.endDate) {\r\n    return { valid: false, message: \"endDate is required\", field: \"endDate\" };\r\n  }\r\n\r\n  if (new Date(data.startDate) >= new Date(data.endDate)) {\r\n    return {\r\n      valid: false,\r\n      message: \"endDate must be after startDate\",\r\n      field: \"endDate\",\r\n    };\r\n  }\r\n\r\n  if (!Array.isArray(data.offerPrices) || data.offerPrices.length === 0) {\r\n    return {\r\n      valid: false,\r\n      message: \"At least one offer price is required\",\r\n      field: \"offerPrices\",\r\n    };\r\n  }\r\n\r\n  for (let i = 0; i < data.offerPrices.length; i++) {\r\n    const offerPrice = data.offerPrices[i];\r\n    if (!offerPrice.ticketId) {\r\n      return { valid: false, message: `offerPrices[${i}].ticketId is required` };\r\n    }\r\n    if (offerPrice.offerPrice === undefined || offerPrice.offerPrice < 0) {\r\n      return { valid: false, message: `offerPrices[${i}].offerPrice must be >= 0` };\r\n    }\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Validate login request\r\n */\r\nexport function validateLoginRequest(data: any): ValidationResult {\n  const hasValidMobile = !!data.mobile && validateMobile(data.mobile);\n  const hasValidEmail = !!data.email && validateEmail(data.email);\n\n  if (!hasValidMobile && !hasValidEmail) {\n    return {\n      valid: false,\n      message: \"Valid mobile or email is required\",\n      field: \"mobile\",\n    };\n  }\n\n  if (!data.password) {\n    return { valid: false, message: \"password is required\", field: \"password\" };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Validate date format (YYYY-MM-DD)\r\n */\r\nexport function validateDateFormat(dateString: string): boolean {\r\n  const dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\r\n  if (!dateRegex.test(dateString)) return false;\r\n\r\n  const date = new Date(dateString);\r\n  return date instanceof Date && !isNaN(date.getTime());\r\n}\r\n\r\n/**\r\n * Validate payment verification request\r\n */\r\nexport function validatePaymentVerificationRequest(data: any): ValidationResult {\r\n  if (!data.bookingReference || typeof data.bookingReference !== \"string\") {\r\n    return {\r\n      valid: false,\r\n      message: \"bookingReference is required and must be a string\",\r\n      field: \"bookingReference\",\r\n    };\r\n  }\r\n\r\n  if (!data.razorpayOrderId || typeof data.razorpayOrderId !== \"string\") {\r\n    return {\r\n      valid: false,\r\n      message: \"razorpayOrderId is required and must be a string\",\r\n      field: \"razorpayOrderId\",\r\n    };\r\n  }\r\n\r\n  if (!data.razorpayPaymentId || typeof data.razorpayPaymentId !== \"string\") {\r\n    return {\r\n      valid: false,\r\n      message: \"razorpayPaymentId is required and must be a string\",\r\n      field: \"razorpayPaymentId\",\r\n    };\r\n  }\r\n\r\n  if (!data.razorpaySignature || typeof data.razorpaySignature !== \"string\") {\r\n    return {\r\n      valid: false,\r\n      message: \"razorpaySignature is required and must be a string\",\r\n      field: \"razorpaySignature\",\r\n    };\r\n  }\r\n\r\n  // Amount verification (critical for security)\r\n  if (data.amount === undefined || typeof data.amount !== \"number\" || data.amount <= 0) {\r\n    return {\r\n      valid: false,\r\n      message: \"amount is required, must be a number, and must be > 0\",\r\n      field: \"amount\",\r\n    };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Validate testimonial request\r\n */\r\nexport function validateTestimonialRequest(data: any): ValidationResult {\r\n  if (!data.name || data.name.trim().length === 0) {\r\n    return { valid: false, message: \"name is required\", field: \"name\" };\r\n  }\r\n\r\n  if (!data.rating || data.rating < 1 || data.rating > 5) {\r\n    return { valid: false, message: \"rating must be between 1 and 5\", field: \"rating\" };\r\n  }\r\n\r\n  if (!data.content || data.content.trim().length === 0) {\r\n    return { valid: false, message: \"content is required\", field: \"content\" };\r\n  }\r\n\r\n  if (!data.visitDate) {\r\n    return { valid: false, message: \"visitDate is required\", field: \"visitDate\" };\r\n  }\r\n\r\n  if (!validateDateFormat(data.visitDate)) {\r\n    return {\r\n      valid: false,\r\n      message: \"visitDate must be in YYYY-MM-DD format\",\r\n      field: \"visitDate\",\r\n    };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Validate announcement request\r\n */\r\nexport function validateAnnouncementRequest(data: any): ValidationResult {\r\n  if (!data.title || data.title.trim().length === 0) {\r\n    return { valid: false, message: \"title is required\", field: \"title\" };\r\n  }\r\n\r\n  if (!data.message && !data.content) {\r\n    return { valid: false, message: \"message is required\", field: \"message\" };\r\n  }\r\n\r\n  if (data.type && ![\"info\", \"warning\", \"notice\"].includes(data.type)) {\r\n    return {\r\n      valid: false,\r\n      message: \"type must be one of: info, warning, notice\",\r\n      field: \"type\",\r\n    };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Validate attraction request\r\n */\r\nexport function validateAttractionRequest(data: any): ValidationResult {\r\n  if (!data.title || data.title.trim().length === 0) {\r\n    return { valid: false, message: \"title is required\", field: \"title\" };\r\n  }\r\n\r\n  if (!data.description || data.description.trim().length === 0) {\r\n    return { valid: false, message: \"description is required\", field: \"description\" };\r\n  }\r\n\r\n  if (!data.imageUrl || data.imageUrl.trim().length === 0) {\r\n    return { valid: false, message: \"imageUrl is required\", field: \"imageUrl\" };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Validate user creation request\r\n */\r\nexport function validateUserCreationRequest(data: any): ValidationResult {\r\n  if (!data.name || data.name.trim().length === 0) {\r\n    return { valid: false, message: \"name is required\", field: \"name\" };\r\n  }\r\n\r\n  if (!data.phone || !validateMobile(data.phone)) {\r\n    return { valid: false, message: \"Valid phone is required\", field: \"phone\" };\r\n  }\r\n\r\n  if (!data.email || !validateEmail(data.email)) {\r\n    return { valid: false, message: \"Valid email is required\", field: \"email\" };\r\n  }\r\n\r\n  if (!data.password) {\r\n    return { valid: false, message: \"password is required\", field: \"password\" };\r\n  }\r\n\r\n  if (!validatePassword(data.password)) {\r\n    return {\r\n      valid: false,\r\n      message: \"password must be at least 6 characters\",\r\n      field: \"password\",\r\n    };\r\n  }\r\n\r\n  if (data.role && ![\"ADMIN\", \"AGENT\"].includes(data.role)) {\r\n    return {\r\n      valid: false,\r\n      message: \"role must be ADMIN or AGENT\",\r\n      field: \"role\",\r\n    };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Validate user status update request\r\n */\r\nexport function validateUserStatusUpdateRequest(data: any): ValidationResult {\r\n  // At least one field should be provided\r\n  if (!data.name && !data.email && !data.mobile && !data.status) {\r\n    return { valid: false, message: \"At least one field must be provided for update\" };\r\n  }\r\n\r\n  if (data.email && !validateEmail(data.email)) {\r\n    return { valid: false, message: \"Valid email is required\", field: \"email\" };\r\n  }\r\n\r\n  if (data.mobile && !validateMobile(data.mobile)) {\r\n    return { valid: false, message: \"Valid mobile is required\", field: \"mobile\" };\r\n  }\r\n\r\n  if (data.status && ![\"ACTIVE\", \"INACTIVE\", \"SUSPENDED\"].includes(data.status)) {\r\n    return { valid: false, message: \"Invalid status value\", field: \"status\" };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 624, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/responses.ts"],"sourcesContent":["// lib/responses.ts - Standardized API responses\r\n\r\nexport interface ApiResponseSuccess<T> {\r\n  success: boolean;\r\n  message: string;\r\n  data: T;\r\n}\r\n\r\nexport interface ApiResponseError {\r\n  success: boolean;\r\n  message: string;\r\n  error: string;\r\n  code?: string;\r\n}\r\n\r\nexport interface PaginatedResponse<T> {\r\n  success: boolean;\r\n  data: T[];\r\n  pagination: {\r\n    currentPage: number;\r\n    pageSize: number;\r\n    totalElements: number;\r\n    totalPages: number;\r\n    hasNext: boolean;\r\n    hasPrevious: boolean;\r\n  };\r\n}\r\n\r\n/**\r\n * Create a success response\r\n */\r\nexport function createSuccessResponse<T>(\r\n  message: string,\r\n  data: T,\r\n): ApiResponseSuccess<T> {\r\n  return {\r\n    success: true,\r\n    message,\r\n    data,\r\n  };\r\n}\r\n\r\n/**\r\n * Create an error response\r\n */\r\nexport function createErrorResponse(\r\n  message: string,\r\n  error: string,\r\n  code?: string,\r\n): ApiResponseError {\r\n  return {\r\n    success: false,\r\n    message,\r\n    error,\r\n    code,\r\n  };\r\n}\r\n\r\n/**\r\n * Create a paginated response\r\n */\r\nexport function createPaginatedResponse<T>(\r\n  message: string,\r\n  items: T[],\r\n  currentPage: number,\r\n  pageSize: number,\r\n  totalElements: number,\r\n): PaginatedResponse<T> & { message: string } {\r\n  const totalPages = Math.ceil(totalElements / pageSize);\r\n\r\n  return {\r\n    success: true,\r\n    message,\r\n    data: items,\r\n    pagination: {\r\n      currentPage,\r\n      pageSize,\r\n      totalElements,\r\n      totalPages,\r\n      hasNext: currentPage < totalPages,\r\n      hasPrevious: currentPage > 1,\r\n    },\r\n  } as any;\r\n}\r\n"],"names":[],"mappings":"AAAA,gDAAgD;;;;;;;;;AA+BzC,SAAS,sBACd,OAAe,EACf,IAAO;IAEP,OAAO;QACL,SAAS;QACT;QACA;IACF;AACF;AAKO,SAAS,oBACd,OAAe,EACf,KAAa,EACb,IAAa;IAEb,OAAO;QACL,SAAS;QACT;QACA;QACA;IACF;AACF;AAKO,SAAS,wBACd,OAAe,EACf,KAAU,EACV,WAAmB,EACnB,QAAgB,EAChB,aAAqB;IAErB,MAAM,aAAa,KAAK,IAAI,CAAC,gBAAgB;IAE7C,OAAO;QACL,SAAS;QACT;QACA,MAAM;QACN,YAAY;YACV;YACA;YACA;YACA;YACA,SAAS,cAAc;YACvB,aAAa,cAAc;QAC7B;IACF;AACF","debugId":null}},
    {"offset": {"line": 668, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/errors.ts"],"sourcesContent":["// lib/errors.ts - Custom error classes\r\n\r\nexport class ApiError extends Error {\r\n  constructor(\r\n    public message: string,\r\n    public status: number = 400,\r\n    public code?: string,\r\n  ) {\r\n    super(message);\r\n    this.name = \"ApiError\";\r\n  }\r\n}\r\n\r\nexport class ValidationError extends ApiError {\r\n  constructor(message: string, public field?: string) {\r\n    super(message, 400, \"VALIDATION_ERROR\");\r\n    this.name = \"ValidationError\";\r\n  }\r\n}\r\n\r\nexport class NotFoundError extends ApiError {\r\n  constructor(message: string) {\r\n    super(message, 404, \"NOT_FOUND\");\r\n    this.name = \"NotFoundError\";\r\n  }\r\n}\r\n\r\nexport class UnauthorizedError extends ApiError {\r\n  constructor(message: string = \"Unauthorized\") {\r\n    super(message, 401, \"UNAUTHORIZED\");\r\n    this.name = \"UnauthorizedError\";\r\n  }\r\n}\r\n\r\nexport class ForbiddenError extends ApiError {\r\n  constructor(message: string = \"Forbidden\") {\r\n    super(message, 403, \"FORBIDDEN\");\r\n    this.name = \"ForbiddenError\";\r\n  }\r\n}\r\n\r\nexport class ConflictError extends ApiError {\r\n  constructor(message: string) {\r\n    super(message, 409, \"CONFLICT\");\r\n    this.name = \"ConflictError\";\r\n  }\r\n}\r\n\r\nexport class InternalServerError extends ApiError {\r\n  constructor(message: string = \"Internal Server Error\") {\r\n    super(message, 500, \"INTERNAL_SERVER_ERROR\");\r\n    this.name = \"InternalServerError\";\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,uCAAuC;;;;;;;;;;;;;;;;;AAEhC,MAAM,iBAAiB;;;;IAC5B,YACE,AAAO,OAAe,EACtB,AAAO,SAAiB,GAAG,EAC3B,AAAO,IAAa,CACpB;QACA,KAAK,CAAC,eAJC,UAAA,cACA,SAAA,aACA,OAAA;QAGP,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAEO,MAAM,wBAAwB;;IACnC,YAAY,OAAe,EAAE,AAAO,KAAc,CAAE;QAClD,KAAK,CAAC,SAAS,KAAK,0BADc,QAAA;QAElC,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAEO,MAAM,sBAAsB;IACjC,YAAY,OAAe,CAAE;QAC3B,KAAK,CAAC,SAAS,KAAK;QACpB,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAEO,MAAM,0BAA0B;IACrC,YAAY,UAAkB,cAAc,CAAE;QAC5C,KAAK,CAAC,SAAS,KAAK;QACpB,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAEO,MAAM,uBAAuB;IAClC,YAAY,UAAkB,WAAW,CAAE;QACzC,KAAK,CAAC,SAAS,KAAK;QACpB,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAEO,MAAM,sBAAsB;IACjC,YAAY,OAAe,CAAE;QAC3B,KAAK,CAAC,SAAS,KAAK;QACpB,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAEO,MAAM,4BAA4B;IACvC,YAAY,UAAkB,uBAAuB,CAAE;QACrD,KAAK,CAAC,SAAS,KAAK;QACpB,IAAI,CAAC,IAAI,GAAG;IACd;AACF","debugId":null}},
    {"offset": {"line": 735, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/whatsapp.ts"],"sourcesContent":["type SendWhatsAppMessageInput = {\n  phone: string;\n  name: string;\n  bookingId: string;\n  date: string;\n  ticketsCount?: number;\n  ticketUrl?: string;\n};\n\nexport async function sendWhatsAppMessage(input: SendWhatsAppMessageInput) {\n  const { phone, name, bookingId, date, ticketsCount, ticketUrl } = input;\n\n  const phoneNumberId = process.env.WHATSAPP_PHONE_NUMBER_ID;\n  const token = process.env.WHATSAPP_TOKEN;\n\n  if (!phoneNumberId || !token) {\n    throw new Error(\"Missing WHATSAPP_PHONE_NUMBER_ID or WHATSAPP_TOKEN\");\n  }\n\n  const endpoint = `https://graph.facebook.com/v19.0/${phoneNumberId}/messages`;\n  const mediaEndpoint = `https://graph.facebook.com/v19.0/${phoneNumberId}/media`;\n  const to =\"91\"+phone.replace(/\\D/g, \"\");\n  const caption = `Booking Confirmed\\nName: ${name}\\nBooking ID: ${bookingId}\\nTickets: ${ticketsCount ?? \"-\"}\\nDate: ${date}`;\n\n  let payload: Record<string, unknown>;\n\n  if (ticketUrl) {\n    try {\n      const fileResponse = await fetch(ticketUrl);\n      console.log(fileResponse)\n      if (!fileResponse.ok) {\n        throw new Error(`Unable to fetch ticket URL: ${fileResponse.status}`);\n      }\n\n      const fileBytes = await fileResponse.arrayBuffer();\n      const fileBlob = new Blob([fileBytes], { type: \"application/pdf\" });\n      const formData = new FormData();\n      formData.append(\"messaging_product\", \"whatsapp\");\n      formData.append(\"file\", fileBlob, `${bookingId}.pdf`);\n\n      const mediaUploadResponse = await fetch(mediaEndpoint, {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n        body: formData,\n      });\n\n      const mediaUploadData = await mediaUploadResponse.json();\n      if (!mediaUploadResponse.ok || !mediaUploadData?.id) {\n        throw new Error(\n          `WhatsApp media upload failed ${mediaUploadResponse.status}: ${JSON.stringify(mediaUploadData)}`,\n        );\n      }\n\n      payload = {\n        messaging_product: \"whatsapp\",\n        to,\n        type: \"document\",\n        document: {\n          id: mediaUploadData.id,\n          filename: `${bookingId}.pdf`,\n          caption,\n        },\n      };\n    } catch (mediaError) {\n      console.error(\"Media upload failed, falling back to link:\", mediaError);\n      payload = {\n        messaging_product: \"whatsapp\",\n        to,\n        type: \"document\",\n        document: {\n          link: ticketUrl,\n          filename: `${bookingId}.pdf`,\n          caption,\n        },\n      };\n    }\n  } else {\n    payload = {\n      messaging_product: \"whatsapp\",\n      to,\n      type: \"text\",\n      text: {\n        body: caption,\n      },\n    };\n  }\n\n  const response = await fetch(endpoint, {\n    method: \"POST\",\n    headers: {\n      Authorization: `Bearer ${token}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify(payload),\n  });\n\n  const data = await response.json();\n  console.log(\"WhatsApp API response:\", data,payload,response);\n  if (!response.ok) {\n    throw new Error(\n      `WhatsApp API error ${response.status}: ${JSON.stringify(data)}`,\n    );\n  }\n\n  return data;\n}\n"],"names":[],"mappings":";;;;AASO,eAAe,oBAAoB,KAA+B;IACvE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,SAAS,EAAE,IAAI,EAAE,YAAY,EAAE,SAAS,EAAE,GAAG;IAElE,MAAM,gBAAgB,QAAQ,GAAG,CAAC,wBAAwB;IAC1D,MAAM,QAAQ,QAAQ,GAAG,CAAC,cAAc;IAExC,IAAI,CAAC,iBAAiB,CAAC,OAAO;QAC5B,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,WAAW,CAAC,iCAAiC,EAAE,cAAc,SAAS,CAAC;IAC7E,MAAM,gBAAgB,CAAC,iCAAiC,EAAE,cAAc,MAAM,CAAC;IAC/E,MAAM,KAAI,OAAK,MAAM,OAAO,CAAC,OAAO;IACpC,MAAM,UAAU,CAAC,yBAAyB,EAAE,KAAK,cAAc,EAAE,UAAU,WAAW,EAAE,gBAAgB,IAAI,QAAQ,EAAE,MAAM;IAE5H,IAAI;IAEJ,IAAI,WAAW;QACb,IAAI;YACF,MAAM,eAAe,MAAM,MAAM;YACjC,QAAQ,GAAG,CAAC;YACZ,IAAI,CAAC,aAAa,EAAE,EAAE;gBACpB,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,aAAa,MAAM,EAAE;YACtE;YAEA,MAAM,YAAY,MAAM,aAAa,WAAW;YAChD,MAAM,WAAW,IAAI,KAAK;gBAAC;aAAU,EAAE;gBAAE,MAAM;YAAkB;YACjE,MAAM,WAAW,IAAI;YACrB,SAAS,MAAM,CAAC,qBAAqB;YACrC,SAAS,MAAM,CAAC,QAAQ,UAAU,GAAG,UAAU,IAAI,CAAC;YAEpD,MAAM,sBAAsB,MAAM,MAAM,eAAe;gBACrD,QAAQ;gBACR,SAAS;oBACP,eAAe,CAAC,OAAO,EAAE,OAAO;gBAClC;gBACA,MAAM;YACR;YAEA,MAAM,kBAAkB,MAAM,oBAAoB,IAAI;YACtD,IAAI,CAAC,oBAAoB,EAAE,IAAI,CAAC,iBAAiB,IAAI;gBACnD,MAAM,IAAI,MACR,CAAC,6BAA6B,EAAE,oBAAoB,MAAM,CAAC,EAAE,EAAE,KAAK,SAAS,CAAC,kBAAkB;YAEpG;YAEA,UAAU;gBACR,mBAAmB;gBACnB;gBACA,MAAM;gBACN,UAAU;oBACR,IAAI,gBAAgB,EAAE;oBACtB,UAAU,GAAG,UAAU,IAAI,CAAC;oBAC5B;gBACF;YACF;QACF,EAAE,OAAO,YAAY;YACnB,QAAQ,KAAK,CAAC,8CAA8C;YAC5D,UAAU;gBACR,mBAAmB;gBACnB;gBACA,MAAM;gBACN,UAAU;oBACR,MAAM;oBACN,UAAU,GAAG,UAAU,IAAI,CAAC;oBAC5B;gBACF;YACF;QACF;IACF,OAAO;QACL,UAAU;YACR,mBAAmB;YACnB;YACA,MAAM;YACN,MAAM;gBACJ,MAAM;YACR;QACF;IACF;IAEA,MAAM,WAAW,MAAM,MAAM,UAAU;QACrC,QAAQ;QACR,SAAS;YACP,eAAe,CAAC,OAAO,EAAE,OAAO;YAChC,gBAAgB;QAClB;QACA,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAChC,QAAQ,GAAG,CAAC,0BAA0B,MAAK,SAAQ;IACnD,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MACR,CAAC,mBAAmB,EAAE,SAAS,MAAM,CAAC,EAAE,EAAE,KAAK,SAAS,CAAC,OAAO;IAEpE;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 830, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/ticket-template.ts"],"sourcesContent":["type TicketTemplateItem = {\n  ticketName: string;\n  quantity: number;\n  appliedPrice: number | string;\n};\n\ntype BuildTicketHtmlInput = {\n  bookingReference: string;\n  visitDate: Date | string;\n  customerName: string;\n  customerMobile: string;\n  totalAmount: number | string;\n  bookingItems: TicketTemplateItem[];\n  qrCodeUrl: string;\n  includePrintButton?: boolean;\n};\n\nfunction formatVisitDate(value: Date | string): string {\n  return new Date(value).toLocaleDateString(\"en-IN\", {\n    weekday: \"short\",\n    month: \"short\",\n    day: \"numeric\",\n    year: \"numeric\",\n  });\n}\n\nfunction escapeHtml(value: string): string {\n  return value\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#039;\");\n}\n\nexport function buildTicketHtml(input: BuildTicketHtmlInput): string {\n  const itemsHtml = input.bookingItems\n    .map(\n      (item) => `\n        <div class=\"ticket-item\">\n          <div class=\"ticket-left\">\n            <div class=\"ticket-name\">${escapeHtml(item.ticketName)}</div>\n            <div class=\"ticket-qty\">Qty: ${item.quantity}</div>\n          </div>\n          <div class=\"ticket-price\">₹${item.appliedPrice}</div>\n        </div>\n      `,\n    )\n    .join(\"\");\n\n  return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"UTF-8\">\n      <title>Aerocity Booking - ${escapeHtml(input.bookingReference)}</title>\n      <style>\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        body {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          padding: 20px;\n          background: #f5f5f5;\n        }\n        .ticket {\n          max-width: 700px;\n          margin: 20px auto;\n          border: 3px solid #0284c7;\n          border-radius: 12px;\n          padding: 40px;\n          background: white;\n          box-shadow: 0 10px 30px rgba(0,0,0,0.1);\n        }\n        .header { text-align: center; margin-bottom: 30px; }\n        .header h1 { font-size: 32px; color: #333; margin-bottom: 5px; font-weight: bold; }\n        .header p { color: #666; font-size: 14px; }\n        .reference {\n          background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);\n          border-radius: 8px;\n          padding: 25px;\n          text-align: center;\n          margin: 25px 0;\n          color: white;\n        }\n        .reference-label { font-size: 11px; font-weight: bold; opacity: 0.9; }\n        .reference-code {\n          font-size: 30px;\n          font-weight: bold;\n          font-family: 'Courier New', monospace;\n          letter-spacing: 3px;\n          margin-top: 10px;\n        }\n        .qr-section { text-align: center; margin: 35px 0; }\n        .qr-section img { max-width: 200px; height: auto; border: 2px solid #ddd; border-radius: 8px; }\n        .qr-section p { margin-top: 12px; font-size: 12px; color: #666; }\n        .details {\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 25px;\n          margin: 30px 0;\n          padding: 20px 0;\n          border-top: 1px solid #eee;\n          border-bottom: 1px solid #eee;\n        }\n        .detail-label {\n          font-size: 11px;\n          color: #666;\n          font-weight: 700;\n          text-transform: uppercase;\n          letter-spacing: 0.5px;\n        }\n        .detail-value {\n          font-size: 16px;\n          color: #333;\n          margin-top: 6px;\n          font-weight: 500;\n        }\n        .tickets-section { margin: 30px 0; }\n        .tickets-section h3 {\n          font-size: 16px;\n          font-weight: bold;\n          margin-bottom: 15px;\n          color: #333;\n        }\n        .ticket-item {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          padding: 12px 0;\n          font-size: 14px;\n          border-bottom: 1px solid #f0f0f0;\n        }\n        .ticket-left { flex: 1; }\n        .ticket-name { color: #333; font-weight: 500; }\n        .ticket-qty { color: #999; font-size: 13px; }\n        .ticket-price { color: #666; font-weight: 500; min-width: 80px; text-align: right; }\n        .total {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          border-top: 2px solid #333;\n          padding-top: 15px;\n          margin-top: 15px;\n          font-weight: bold;\n          font-size: 20px;\n          color: #0284c7;\n        }\n        .footer {\n          text-align: center;\n          margin-top: 40px;\n          font-size: 11px;\n          color: #999;\n          padding-top: 20px;\n          border-top: 1px solid #eee;\n        }\n        .print-button { text-align: center; margin-top: 30px; }\n        .print-button button {\n          background: #0284c7;\n          color: white;\n          border: none;\n          padding: 12px 30px;\n          font-size: 16px;\n          border-radius: 6px;\n          cursor: pointer;\n          font-weight: 600;\n        }\n        .print-button button:hover { background: #0369a1; }\n        @media print {\n          body { padding: 0; margin: 0; background: white; }\n          .ticket { margin: 0; box-shadow: none; page-break-inside: avoid; }\n          .print-button { display: none; }\n        }\n      </style>\n    </head>\n    <body>\n      <div class=\"ticket\">\n        <div class=\"header\">\n          <h1>AEROCITY</h1>\n          <p>Water Park Booking Ticket</p>\n        </div>\n\n        <div class=\"reference\">\n          <div class=\"reference-label\">Booking Reference</div>\n          <div class=\"reference-code\">${escapeHtml(input.bookingReference)}</div>\n        </div>\n\n        <div class=\"qr-section\">\n          <img src=\"${escapeHtml(input.qrCodeUrl)}\" alt=\"Booking QR Code\" />\n          <p>Scan this code at gate for entry</p>\n        </div>\n\n        <div class=\"details\">\n          <div class=\"detail-group\">\n            <div class=\"detail-label\">Visit Date</div>\n            <div class=\"detail-value\">${escapeHtml(formatVisitDate(input.visitDate))}</div>\n          </div>\n          <div class=\"detail-group\">\n            <div class=\"detail-label\">Status</div>\n            <div class=\"detail-value\" style=\"color: green;\">✓ Confirmed</div>\n          </div>\n          <div class=\"detail-group\">\n            <div class=\"detail-label\">Customer Name</div>\n            <div class=\"detail-value\">${escapeHtml(input.customerName)}</div>\n          </div>\n          <div class=\"detail-group\">\n            <div class=\"detail-label\">Mobile</div>\n            <div class=\"detail-value\">${escapeHtml(input.customerMobile)}</div>\n          </div>\n        </div>\n\n        <div class=\"tickets-section\">\n          <h3>Tickets</h3>\n          ${itemsHtml}\n          <div class=\"total\">\n            <span>Total Amount</span>\n            <span>₹${input.totalAmount}</span>\n          </div>\n        </div>\n\n        <div class=\"footer\">\n          <p>This is your booking confirmation. Keep this ticket for entry.</p>\n          <p>Contact: support@aerocity.com | +91-XXXX-XXXX</p>\n          <p>Generated: ${new Date().toLocaleString(\"en-IN\")}</p>\n        </div>\n      </div>\n\n      ${\n        input.includePrintButton\n          ? `\n      <div class=\"print-button\">\n        <button onclick=\"window.print()\">Print to PDF</button>\n      </div>\n      `\n          : \"\"\n      }\n    </body>\n    </html>\n  `;\n}\n"],"names":[],"mappings":";;;;AAiBA,SAAS,gBAAgB,KAAoB;IAC3C,OAAO,IAAI,KAAK,OAAO,kBAAkB,CAAC,SAAS;QACjD,SAAS;QACT,OAAO;QACP,KAAK;QACL,MAAM;IACR;AACF;AAEA,SAAS,WAAW,KAAa;IAC/B,OAAO,MACJ,OAAO,CAAC,MAAM,SACd,OAAO,CAAC,MAAM,QACd,OAAO,CAAC,MAAM,QACd,OAAO,CAAC,MAAM,UACd,OAAO,CAAC,MAAM;AACnB;AAEO,SAAS,gBAAgB,KAA2B;IACzD,MAAM,YAAY,MAAM,YAAY,CACjC,GAAG,CACF,CAAC,OAAS,CAAC;;;qCAGoB,EAAE,WAAW,KAAK,UAAU,EAAE;yCAC1B,EAAE,KAAK,QAAQ,CAAC;;qCAEpB,EAAE,KAAK,YAAY,CAAC;;MAEnD,CAAC,EAEF,IAAI,CAAC;IAER,OAAO,CAAC;;;;;gCAKsB,EAAE,WAAW,MAAM,gBAAgB,EAAE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;sCA+H/B,EAAE,WAAW,MAAM,gBAAgB,EAAE;;;;oBAIvD,EAAE,WAAW,MAAM,SAAS,EAAE;;;;;;;sCAOZ,EAAE,WAAW,gBAAgB,MAAM,SAAS,GAAG;;;;;;;;sCAQ/C,EAAE,WAAW,MAAM,YAAY,EAAE;;;;sCAIjC,EAAE,WAAW,MAAM,cAAc,EAAE;;;;;;UAM/D,EAAE,UAAU;;;mBAGH,EAAE,MAAM,WAAW,CAAC;;;;;;;wBAOf,EAAE,IAAI,OAAO,cAAc,CAAC,SAAS;;;;MAIvD,EACE,MAAM,kBAAkB,GACpB,CAAC;;;;MAIP,CAAC,GACK,GACL;;;EAGL,CAAC;AACH","debugId":null}},
    {"offset": {"line": 1049, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/generate-ticket-pdf.ts"],"sourcesContent":["import { buildTicketHtml } from \"@/lib/ticket-template\";\n\ntype TicketLine = {\n  name: string;\n  quantity: number;\n  unitPrice: number;\n  lineTotal: number;\n};\n\ntype GenerateTicketPdfInput = {\n  bookingReference: string;\n  customerName: string;\n  customerMobile: string;\n  visitDate: Date | string;\n  totalAmount: number | string;\n  tickets: TicketLine[];\n};\n\nexport async function generateTicketPDF(input: GenerateTicketPdfInput): Promise<Buffer> {\n  const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(\n    input.bookingReference,\n  )}`;\n\n  const html = buildTicketHtml({\n    bookingReference: input.bookingReference,\n    visitDate: input.visitDate,\n    customerName: input.customerName,\n    customerMobile: input.customerMobile,\n    totalAmount: input.totalAmount,\n    qrCodeUrl,\n    bookingItems: input.tickets.map((item) => ({\n      ticketName: item.name,\n      quantity: item.quantity,\n      appliedPrice: item.lineTotal.toFixed(2),\n    })),\n  });\n\n  let chromium: any;\n  try {\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const playwright = require(\"playwright\");\n    chromium = playwright.chromium;\n  } catch {\n    throw new Error(\n      \"Missing playwright dependency. Run: pnpm add playwright && npx playwright install chromium\",\n    );\n  }\n\n  const browser = await chromium.launch({ headless: true });\n  try {\n    const page = await browser.newPage();\n    await page.setContent(html, { waitUntil: \"networkidle\" });\n    const pdf = await page.pdf({\n      format: \"A4\",\n      printBackground: true,\n      margin: {\n        top: \"10mm\",\n        right: \"10mm\",\n        bottom: \"10mm\",\n        left: \"10mm\",\n      },\n    });\n    return Buffer.from(pdf);\n  } finally {\n    await browser.close();\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAkBO,eAAe,kBAAkB,KAA6B;IACnE,MAAM,YAAY,CAAC,8DAA8D,EAAE,mBACjF,MAAM,gBAAgB,GACrB;IAEH,MAAM,OAAO,IAAA,8IAAe,EAAC;QAC3B,kBAAkB,MAAM,gBAAgB;QACxC,WAAW,MAAM,SAAS;QAC1B,cAAc,MAAM,YAAY;QAChC,gBAAgB,MAAM,cAAc;QACpC,aAAa,MAAM,WAAW;QAC9B;QACA,cAAc,MAAM,OAAO,CAAC,GAAG,CAAC,CAAC,OAAS,CAAC;gBACzC,YAAY,KAAK,IAAI;gBACrB,UAAU,KAAK,QAAQ;gBACvB,cAAc,KAAK,SAAS,CAAC,OAAO,CAAC;YACvC,CAAC;IACH;IAEA,IAAI;IACJ,IAAI;QACF,8DAA8D;QAC9D,MAAM;QACN,WAAW,WAAW,QAAQ;IAChC,EAAE,OAAM;QACN,MAAM,IAAI,MACR;IAEJ;IAEA,MAAM,UAAU,MAAM,SAAS,MAAM,CAAC;QAAE,UAAU;IAAK;IACvD,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,OAAO;QAClC,MAAM,KAAK,UAAU,CAAC,MAAM;YAAE,WAAW;QAAc;QACvD,MAAM,MAAM,MAAM,KAAK,GAAG,CAAC;YACzB,QAAQ;YACR,iBAAiB;YACjB,QAAQ;gBACN,KAAK;gBACL,OAAO;gBACP,QAAQ;gBACR,MAAM;YACR;QACF;QACA,OAAO,OAAO,IAAI,CAAC;IACrB,SAAU;QACR,MAAM,QAAQ,KAAK;IACrB;AACF","debugId":null}},
    {"offset": {"line": 1147, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/cloudinary.ts"],"sourcesContent":["import { v2 as cloudinary } from \"cloudinary\";\r\n\r\ncloudinary.config({\r\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n  api_key: process.env.CLOUDINARY_API_KEY,\r\n  api_secret: process.env.CLOUDINARY_API_SECRET,\r\n});\r\n\r\nexport default cloudinary;"],"names":[],"mappings":";;;;AAAA;;AAEA,uMAAU,CAAC,MAAM,CAAC;IAChB,YAAY,QAAQ,GAAG,CAAC,qBAAqB;IAC7C,SAAS,QAAQ,GAAG,CAAC,kBAAkB;IACvC,YAAY,QAAQ,GAAG,CAAC,qBAAqB;AAC/C;uCAEe,uMAAU","debugId":null}},
    {"offset": {"line": 1163, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/lib/uploadTicket.ts"],"sourcesContent":["import cloudinary from \"@/lib/cloudinary\";\r\n\r\nexport async function uploadTicket(\r\n  pdfBuffer: Buffer,\r\n  bookingId: string\r\n) {\r\n  return new Promise<string>((resolve, reject) => {\r\n    cloudinary.uploader.upload_stream(\n      {\n        resource_type: \"raw\",\n        public_id: `tickets/${bookingId}`,\n        format: \"pdf\",\n        overwrite: true,\n        invalidate: true,\n      },\n      (error, result) => {\n        if (error || !result) return reject(error);\r\n        resolve(result.secure_url);\r\n      }\r\n    ).end(pdfBuffer);\r\n  });\r\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,aACpB,SAAiB,EACjB,SAAiB;IAEjB,OAAO,IAAI,QAAgB,CAAC,SAAS;QACnC,8HAAU,CAAC,QAAQ,CAAC,aAAa,CAC/B;YACE,eAAe;YACf,WAAW,CAAC,QAAQ,EAAE,WAAW;YACjC,QAAQ;YACR,WAAW;YACX,YAAY;QACd,GACA,CAAC,OAAO;YACN,IAAI,SAAS,CAAC,QAAQ,OAAO,OAAO;YACpC,QAAQ,OAAO,UAAU;QAC3B,GACA,GAAG,CAAC;IACR;AACF","debugId":null}},
    {"offset": {"line": 1187, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/Aerocity/AEROCITY-FE/Aerocity/app/api/bookings/verify-payment/route.ts"],"sourcesContent":["// app/api/bookings/verify-payment/route.ts - Verify payment and update booking\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { verifyRazorpaySignature } from \"@/lib/razorpay-utils\";\nimport { validatePaymentVerificationRequest } from \"@/lib/validators\";\nimport { createSuccessResponse, createErrorResponse } from \"@/lib/responses\";\nimport { ValidationError, NotFoundError } from \"@/lib/errors\";\nimport { sendWhatsAppMessage } from \"@/lib/whatsapp\";\nimport { generateTicketPDF } from \"@/lib/generate-ticket-pdf\";\nimport { uploadTicket } from \"@/lib/uploadTicket\";\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n\r\n    // Validate input\r\n    const validation = validatePaymentVerificationRequest(body);\r\n    if (!validation.valid) {\r\n      return NextResponse.json(\n        createErrorResponse(\n          \"Validation failed\",\n          validation.message || \"Invalid payment verification request\",\n          \"VALIDATION_ERROR\",\n        ),\n        { status: 400 },\n      );\n    }\n\r\n    const { bookingReference, razorpayOrderId, razorpayPaymentId, razorpaySignature, amount } = body;\r\n\r\n    // Use database transaction for atomic payment processing\r\n    const result = await prisma.$transaction(async (tx) => {\n      // 1. Find booking and lock it (FOR UPDATE equivalent in Prisma)\r\n      const booking = await tx.booking.findUnique({\r\n        where: { bookingReference },\r\n      });\r\n\r\n      if (!booking) {\r\n        throw new NotFoundError(\"Booking not found\");\r\n      }\r\n\r\n      // 2. IDEMPOTENCY CHECK - if already paid, return success\r\n      if (booking.paymentStatus === \"PAID\" && booking.razorpayPaymentId === razorpayPaymentId) {\r\n        return {\r\n          success: true,\r\n          bookingReference: booking.bookingReference,\r\n          paymentStatus: booking.paymentStatus,\r\n          razorpayPaymentId: booking.razorpayPaymentId,\r\n          message: \"Payment already processed\",\r\n        };\r\n      }\r\n\r\n      // 3. PREVENT DOUBLE-PROCESSING - if payment already exists for different booking\r\n      if (booking.razorpayPaymentId && booking.razorpayPaymentId !== razorpayPaymentId) {\r\n        throw new ValidationError(\r\n          \"Booking already has a different payment. Cannot process new payment.\",\r\n          \"razorpayPaymentId\",\r\n        );\r\n      }\r\n\r\n      // 4. ORDER ID VERIFICATION\r\n      if (booking.razorpayOrderId && booking.razorpayOrderId !== razorpayOrderId) {\r\n        throw new ValidationError(\r\n          \"Order ID mismatch. Payment verification failed.\",\r\n          \"razorpayOrderId\",\r\n        );\r\n      }\r\n\r\n      // 5. AMOUNT VERIFICATION (CRITICAL SECURITY CHECK)\r\n      const bookingAmount = Number(booking.totalAmount);\r\n      const paidAmount = Number(amount);\r\n      const tolerance = 0.01; // Allow 1 paisa difference for rounding\r\n\r\n      if (Math.abs(bookingAmount - paidAmount) > tolerance) {\r\n        console.warn(\r\n          `Amount mismatch for booking ${bookingReference}: expected ${bookingAmount}, got ${paidAmount}`,\r\n        );\r\n        throw new ValidationError(\r\n          \"Payment amount does not match booking total. Fraud prevention triggered.\",\r\n          \"amount\",\r\n        );\r\n      }\r\n\r\n      // 6. VERIFY RAZORPAY SIGNATURE\r\n      const isValid = await verifyRazorpaySignature(\r\n        razorpayOrderId,\r\n        razorpayPaymentId,\r\n        razorpaySignature,\r\n      );\r\n\r\n      if (!isValid) {\r\n        // Payment signature invalid - update booking to FAILED\r\n        await tx.booking.update({\r\n          where: { id: booking.id },\r\n          data: {\r\n            paymentStatus: \"FAILED\",\r\n            razorpayPaymentId,\r\n          },\r\n        });\r\n\r\n        throw new ValidationError(\r\n          \"Invalid payment signature. Payment not verified.\",\r\n          \"razorpaySignature\",\r\n        );\r\n      }\r\n\r\n      // 7. PAYMENT VERIFIED - Update booking to PAID\r\n      const updatedBooking = await tx.booking.update({\r\n        where: { id: booking.id },\r\n        data: {\r\n          paymentStatus: \"PAID\",\r\n          razorpayOrderId,\r\n          razorpayPaymentId,\r\n        },\r\n      });\r\n\r\n      return {\n        success: true,\n        bookingReference: updatedBooking.bookingReference,\n        paymentStatus: updatedBooking.paymentStatus,\n        razorpayPaymentId: updatedBooking.razorpayPaymentId,\n      };\n    });\n\n    // Run notifications server-side so they don't depend on client connectivity.\n    (async () => {\n      try {\n        const booking = await prisma.booking.findUnique({\n          where: { bookingReference: result.bookingReference },\n          include: {\n            bookingItems: {\n              include: {\n                ticket: {\n                  select: { name: true },\n                },\n              },\n            },\n          },\n        });\n\n        if (!booking) return;\n\n        let ticketUrl: string | undefined;\n        try {\n          const pdfBuffer = await generateTicketPDF({\n            bookingReference: booking.bookingReference,\n            customerName: booking.customerName,\n            customerMobile: booking.customerMobile,\n            visitDate: booking.visitDate,\n            totalAmount: booking.totalAmount.toString(),\n            tickets: booking.bookingItems.map((item) => ({\n              name: item.ticket.name,\n              quantity: item.quantity,\n              unitPrice: Number(item.appliedPrice),\n              lineTotal: Number(item.totalPrice),\n            })),\n          });\n\n          ticketUrl = await uploadTicket(pdfBuffer, booking.bookingReference);\n        } catch (pdfError) {\n          console.error(\"Ticket PDF generation/upload failed:\", pdfError);\n        }\n\n        await sendWhatsAppMessage({\n          phone: booking.customerMobile,\n          name: booking.customerName,\n          bookingId: booking.bookingReference,\n          date: new Date(booking.visitDate).toISOString().split(\"T\")[0],\n          ticketsCount: booking.bookingItems.reduce(\n            (sum, item) => sum + item.quantity,\n            0,\n          ),\n          ticketUrl,\n        });\n      } catch (notificationError) {\n        console.error(\"Post-payment WhatsApp notification failed:\", notificationError);\n      }\n    })();\n\n    return NextResponse.json(\n      createSuccessResponse(\n        result.message || \"Payment verified successfully\",\r\n        {\r\n          bookingReference: result.bookingReference,\r\n          paymentStatus: result.paymentStatus,\r\n          razorpayPaymentId: result.razorpayPaymentId,\r\n        },\r\n      ),\r\n      { status: 200 },\r\n    );\r\n  } catch (error: any) {\r\n    console.error(\"Payment verification error:\", error);\r\n\r\n    if (error instanceof ValidationError) {\r\n      return NextResponse.json(\r\n        createErrorResponse(\r\n          \"Validation failed\",\r\n          error.message,\r\n          \"VALIDATION_ERROR\",\r\n        ),\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    if (error instanceof NotFoundError) {\r\n      return NextResponse.json(\r\n        createErrorResponse(\"Not found\", error.message, \"NOT_FOUND\"),\r\n        { status: 404 },\r\n      );\r\n    }\r\n\r\n    return NextResponse.json(\r\n      createErrorResponse(\r\n        \"Payment verification failed\",\r\n        error.message || \"Internal server error\",\r\n      ),\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,+EAA+E;;;;;AAC/E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAE/B,iBAAiB;QACjB,MAAM,aAAa,IAAA,yJAAkC,EAAC;QACtD,IAAI,CAAC,WAAW,KAAK,EAAE;YACrB,OAAO,gRAAY,CAAC,IAAI,CACtB,IAAA,yIAAmB,EACjB,qBACA,WAAW,OAAO,IAAI,wCACtB,qBAEF;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,EAAE,gBAAgB,EAAE,eAAe,EAAE,iBAAiB,EAAE,iBAAiB,EAAE,MAAM,EAAE,GAAG;QAE5F,yDAAyD;QACzD,MAAM,SAAS,MAAM,qHAAM,CAAC,YAAY,CAAC,OAAO;YAC9C,gEAAgE;YAChE,MAAM,UAAU,MAAM,GAAG,OAAO,CAAC,UAAU,CAAC;gBAC1C,OAAO;oBAAE;gBAAiB;YAC5B;YAEA,IAAI,CAAC,SAAS;gBACZ,MAAM,IAAI,gIAAa,CAAC;YAC1B;YAEA,yDAAyD;YACzD,IAAI,QAAQ,aAAa,KAAK,UAAU,QAAQ,iBAAiB,KAAK,mBAAmB;gBACvF,OAAO;oBACL,SAAS;oBACT,kBAAkB,QAAQ,gBAAgB;oBAC1C,eAAe,QAAQ,aAAa;oBACpC,mBAAmB,QAAQ,iBAAiB;oBAC5C,SAAS;gBACX;YACF;YAEA,iFAAiF;YACjF,IAAI,QAAQ,iBAAiB,IAAI,QAAQ,iBAAiB,KAAK,mBAAmB;gBAChF,MAAM,IAAI,kIAAe,CACvB,wEACA;YAEJ;YAEA,2BAA2B;YAC3B,IAAI,QAAQ,eAAe,IAAI,QAAQ,eAAe,KAAK,iBAAiB;gBAC1E,MAAM,IAAI,kIAAe,CACvB,mDACA;YAEJ;YAEA,mDAAmD;YACnD,MAAM,gBAAgB,OAAO,QAAQ,WAAW;YAChD,MAAM,aAAa,OAAO;YAC1B,MAAM,YAAY,MAAM,wCAAwC;YAEhE,IAAI,KAAK,GAAG,CAAC,gBAAgB,cAAc,WAAW;gBACpD,QAAQ,IAAI,CACV,CAAC,4BAA4B,EAAE,iBAAiB,WAAW,EAAE,cAAc,MAAM,EAAE,YAAY;gBAEjG,MAAM,IAAI,kIAAe,CACvB,4EACA;YAEJ;YAEA,+BAA+B;YAC/B,MAAM,UAAU,MAAM,IAAA,qJAAuB,EAC3C,iBACA,mBACA;YAGF,IAAI,CAAC,SAAS;gBACZ,uDAAuD;gBACvD,MAAM,GAAG,OAAO,CAAC,MAAM,CAAC;oBACtB,OAAO;wBAAE,IAAI,QAAQ,EAAE;oBAAC;oBACxB,MAAM;wBACJ,eAAe;wBACf;oBACF;gBACF;gBAEA,MAAM,IAAI,kIAAe,CACvB,oDACA;YAEJ;YAEA,+CAA+C;YAC/C,MAAM,iBAAiB,MAAM,GAAG,OAAO,CAAC,MAAM,CAAC;gBAC7C,OAAO;oBAAE,IAAI,QAAQ,EAAE;gBAAC;gBACxB,MAAM;oBACJ,eAAe;oBACf;oBACA;gBACF;YACF;YAEA,OAAO;gBACL,SAAS;gBACT,kBAAkB,eAAe,gBAAgB;gBACjD,eAAe,eAAe,aAAa;gBAC3C,mBAAmB,eAAe,iBAAiB;YACrD;QACF;QAEA,6EAA6E;QAC7E,CAAC;YACC,IAAI;gBACF,MAAM,UAAU,MAAM,qHAAM,CAAC,OAAO,CAAC,UAAU,CAAC;oBAC9C,OAAO;wBAAE,kBAAkB,OAAO,gBAAgB;oBAAC;oBACnD,SAAS;wBACP,cAAc;4BACZ,SAAS;gCACP,QAAQ;oCACN,QAAQ;wCAAE,MAAM;oCAAK;gCACvB;4BACF;wBACF;oBACF;gBACF;gBAEA,IAAI,CAAC,SAAS;gBAEd,IAAI;gBACJ,IAAI;oBACF,MAAM,YAAY,MAAM,IAAA,uJAAiB,EAAC;wBACxC,kBAAkB,QAAQ,gBAAgB;wBAC1C,cAAc,QAAQ,YAAY;wBAClC,gBAAgB,QAAQ,cAAc;wBACtC,WAAW,QAAQ,SAAS;wBAC5B,aAAa,QAAQ,WAAW,CAAC,QAAQ;wBACzC,SAAS,QAAQ,YAAY,CAAC,GAAG,CAAC,CAAC,OAAS,CAAC;gCAC3C,MAAM,KAAK,MAAM,CAAC,IAAI;gCACtB,UAAU,KAAK,QAAQ;gCACvB,WAAW,OAAO,KAAK,YAAY;gCACnC,WAAW,OAAO,KAAK,UAAU;4BACnC,CAAC;oBACH;oBAEA,YAAY,MAAM,IAAA,qIAAY,EAAC,WAAW,QAAQ,gBAAgB;gBACpE,EAAE,OAAO,UAAU;oBACjB,QAAQ,KAAK,CAAC,wCAAwC;gBACxD;gBAEA,MAAM,IAAA,wIAAmB,EAAC;oBACxB,OAAO,QAAQ,cAAc;oBAC7B,MAAM,QAAQ,YAAY;oBAC1B,WAAW,QAAQ,gBAAgB;oBACnC,MAAM,IAAI,KAAK,QAAQ,SAAS,EAAE,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;oBAC7D,cAAc,QAAQ,YAAY,CAAC,MAAM,CACvC,CAAC,KAAK,OAAS,MAAM,KAAK,QAAQ,EAClC;oBAEF;gBACF;YACF,EAAE,OAAO,mBAAmB;gBAC1B,QAAQ,KAAK,CAAC,8CAA8C;YAC9D;QACF,CAAC;QAED,OAAO,gRAAY,CAAC,IAAI,CACtB,IAAA,2IAAqB,EACnB,OAAO,OAAO,IAAI,iCAClB;YACE,kBAAkB,OAAO,gBAAgB;YACzC,eAAe,OAAO,aAAa;YACnC,mBAAmB,OAAO,iBAAiB;QAC7C,IAEF;YAAE,QAAQ;QAAI;IAElB,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,+BAA+B;QAE7C,IAAI,iBAAiB,kIAAe,EAAE;YACpC,OAAO,gRAAY,CAAC,IAAI,CACtB,IAAA,yIAAmB,EACjB,qBACA,MAAM,OAAO,EACb,qBAEF;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,iBAAiB,gIAAa,EAAE;YAClC,OAAO,gRAAY,CAAC,IAAI,CACtB,IAAA,yIAAmB,EAAC,aAAa,MAAM,OAAO,EAAE,cAChD;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gRAAY,CAAC,IAAI,CACtB,IAAA,yIAAmB,EACjB,+BACA,MAAM,OAAO,IAAI,0BAEnB;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}